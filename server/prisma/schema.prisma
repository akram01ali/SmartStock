generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = -1
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Measures {
  centimeters
  meters
  amount
}

enum TypeOfComponent {
  printer
  group
  assembly
  component
}

enum ReservationStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
}

model Components {
  componentName         String @unique
  amount                Float
  measure               Measures
  lastScanned           DateTime @default(now())
  scannedBy             String
  durationOfDevelopment Float
  triggerMinAmount      Float
  supplier              String
  cost                  Float
  type                  TypeOfComponent
  description           String?
  image                 String?
  delivery_time         Float?
  location              Float?
  manuals               ComponentManual[]
  
  @@index([type])
  @@index([lastScanned])
  @@index([amount])
}

model ComponentHistory {
  componentName         String
  amount                Float
  scanned               DateTime
  scannedBy             String

  @@unique([componentName, amount, scanned, scannedBy])
}

model Relationships {
  topComponent        String
  subComponent        String
  amount              Float

  @@unique([topComponent, subComponent])
}

model Users {
  username            String @unique
  password            String
}

model AppUser {
  name        String
  surname     String
  initials    String
  password    String

  @@unique([name, surname])
}

model Reservations {
  id                String
  isRoot            Boolean @default(false)
  level             Int @default(0)
  title             String
  componentName     String
  quantity          Float
  priority          Int
  requestedBy       String
  neededByDate      DateTime?
  status            ReservationStatus @default(pending)
  createdAt         DateTime @default(now())
  
  @@id([id, componentName])
  @@index([priority, neededByDate])
  @@index([componentName, status])
  @@index([isRoot])
  @@index([level])
}

model ReservationAllocations {
  reservationId     String
  componentName     String
  allocatedQuantity Float
  shortfallQuantity Float @default(0)
  allocationOrder   Int
  
  @@id([reservationId, componentName])
  @@index([componentName, allocationOrder])
  @@index([shortfallQuantity])
}

model PurchaseRequirements {
  id               String @id @default(cuid())
  componentName    String
  requiredQuantity Float
  neededByDate     DateTime
  status           String @default("pending")
  createdAt        DateTime @default(now())
  
  @@index([componentName, status])
  @@index([neededByDate])
}

model ComponentManual {
  id               String   @id @default(cuid())
  componentName    String
  component       Components @relation(fields: [componentName], references: [componentName], onDelete: Cascade)
  fileName         String
  fileUrl          String
  fileType         String   // pdf, docx, doc, etc.
  uploadedAt       DateTime @default(now())
  uploadedBy       String
  
  @@index([componentName])
  @@index([uploadedAt])
}

model ControlChecklistTemplate {
  id               String   @id @default(cuid())
  name             String
  description      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  items            ControlChecklistItem[]
  checklists       ControlChecklist[]
  
  @@index([createdAt])
}

model ControlChecklistItem {
  id               String   @id @default(cuid())
  templateId       String
  template         ControlChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  label            String
  type             String   // 'test' or 'control'
  order            Int
  createdAt        DateTime @default(now())
  
  entries          ControlChecklistEntry[]
  
  @@index([templateId])
  @@unique([templateId, order])
}

model ControlChecklist {
  id                     String   @id @default(cuid())
  printerSerialNumber    String
  templateId             String
  template               ControlChecklistTemplate @relation(fields: [templateId], references: [id])
  status                 String   @default("draft") // 'draft', 'completed', 'shipped'
  shippedAt              DateTime?
  createdAt              DateTime @default(now())
  completedAt            DateTime?
  
  entries                ControlChecklistEntry[]
  
  @@index([printerSerialNumber])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
  @@unique([printerSerialNumber, templateId, createdAt])
}

model ControlChecklistEntry {
  id                 String   @id @default(cuid())
  checklistId        String
  checklist          ControlChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  itemId             String
  item               ControlChecklistItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  isChecked          Boolean  @default(false)
  value              String?
  comment            String?
  
  @@index([checklistId])
  @@index([itemId])
  @@unique([checklistId, itemId])
}